#!/bin/sh

set -e

DOE_DIR=doe
DOE_BASEDIR=~
DOE_HOMEDIR=${DOE_BASEDIR}/$DOE_DIR
DOE_CFGDIR=$DOE_HOMEDIR/etc
DOE_TMPDIR=$DOE_HOMEDIR/.tmp
DOE_MODDIR=$DOE_HOMEDIR/modules
DOE_BACKUPDIR=$DOE_HOMEDIR/.install/.backup

RED='\033[0;31m'	# Cyan color 
NC='\033[0m'		# No Color

. ${DOE_CFGDIR}/doe.conf

# Call module and functions files with  additional parametr
call_module()
{
    # argv[1]=$1=module_name, argv[2]=$2=function_name, $@=all_args
    # Check if directory ("module") exist
    # call "doe <module>" function. Print help if no such function in module. Stop execution
    if [ -d "${DOE_MODDIR}/$1" ]
    then
	call_module_function "$@"  || echo "${RED}Usage:\n\tdoe $1 <function>\n\n\tfunctions = { $(list_module_functions $1) }${NC}" && exit 0
    else
	return 1
    fi
}

call_module_function()
{
    if [ "$2" = "list-functions" ]
    then
	    list_module_functions "$1"
	    return 0
    else
        m_f="${DOE_MODDIR}/$1/$1_$2"
	shift 2

	[ -f "${m_f}" ] && . "${m_f}" "$@" || return 1
    fi
}

list_modules()
{
    # no_args
    # Find all dirictories ("modules") in the directory with all modules
    # Replace all newlines with space
    # Add default modules
    # return $string
    echo "$(cd $DOE_MODDIR; find * -type d -maxdepth 0 2>/dev/null  | tr '\n' ' ')version help"
}

list_module_functions()
{
    # argv[1] = $1 = module_name
    # Find all files ("functions") in the module directory
    # Cut module name
    # Replace all newlines with space
    # Add default functions
    # return $string
    echo "$(cd $DOE_MODDIR/$1; find * -type f -maxdepth 0 2>/dev/null | cut -d'_' -f2 | tr '\n' ' ')help"
}


################################################################################
#
# [raccoon1@amoeba:~]$ doe _self init
#
################################################################################

if [ $# -eq 0 ]				# if no args
then
    eval "$0 ${default_function}"	# re-exec "doe" with default function
else					# else call "doe" module
    case $1 in				# module = $1
	list-modules)			# predefined module for autocompletion with <TAB><TAB>
		list_modules		# show list of available modules for autocompetion
		;;
	version)			#  predefined module aka show_version()
		cat $DOE_CFGDIR/doe-release
		;;
	$1)				# call "doe" module. Print help if no such module
		call_module "$@" || echo "${RED}Usage:\n\tdoe <module>\n\n\tmodule = { $(list_modules) }${NC}"
    esac
fi

exit 0
